<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Decouple Your Powershell Modules Using Events</title>
  <meta name="description" content="(Source Code is available in this GithHub repository) Powershell Modules When building a code base of any language, we want to keep the code organised in encapsulated modules. This enable the code to be testable, maintainable and reusable Powershell offers several ways of organising the code, but the most used is to organise them in Modules. A module in Powershell can include a Manifest file that declares (among other details) the Modules that this Module depends on. This dependencies will be pre-loaded when the target Module is loaded. For .Net development, this is similar to dependencies declared in NUget packages. The Manifest .psd1 file is comparable to the .nuspec file in NUget. Why decoupling? Even with a tidy organisation of Modules, code reuse and modularity start to show their ugly face: dependency hell In particular, this article is concerned with two of the problems identified as a side effect of modularity: Many dependencies Long chain of dependencies Too many (unwanted) dependencies loaded First attempts at code modularisation do, at some point, fall short in specificity. A module that deals with, for example, deploying an application to an environment, could end up loading modules that are not needed for that specific use case. figure 1 - Diagram of highly coupled modules For example, figure 1 shows a 4-tier hierarchy of dependencies between modules. The module SystemInstaller installs software in the current machine (cloud or on premises). One commandlet in this module needs to tag the source code when software is ready to be tested. When this happens, the SCM module updates an internal Dashboard. Loading SystemInstaller will also load SCM, InternalDashoard and EmailSender modules. But if we need to just call Install-LocalApp we will only need EmailSender. These modules may be used in different occasions and scenarios. The combination of these use cases will very likely result in highly coupled modules like in this example, or sometimes much worse. Long chain of dependencies Another side effect of loading unwanted modules is that we will also load the dependencies of these unwanted modules. As time passes, more dependencies are loaded to these transitive dependencies and&amp;#8230;&amp;#8203;.one day we find out that loading one module ends up loading 20 modules, of which we only need one or two. This takes up time consumes resources&amp;#8230;&amp;#8203;and it can have unwanted side effects in your environment, such as installing software or writing to the file system. Decoupling Powershell modules with Events A better module organisation is to have a &quot;flatter&quot; hierarchical structure. The top-level modules represent specific use cases, where the lower level are the building blocks. Developers can use the building blocks provided they use get-help and understand the extent of a module. Here is a representation of a flat hierarchy of modules for the previous graph. In this model, Top Level modules can be thought as mediators of the building blocks. They represent the top level use case that knows what are the different building blocks in place. Dealing with Email Servers, Source Control Management Systems and Dashboards are all independent of each other. Use cases that need one of these libraries, will import the modules and &quot;wire&quot; them together in a publish-and-subscribe approach. Powershell support for events is neither widely used nor documented, but the language provides the building blocks necessary to implement such pattern. Implementation: Using events to decouple modules Building blocks The EmailSender and InternalDashboard modules have no dependencies. Their input parameters can be simple primitives like strings or integers. This make these building block modules very easy to test and develop. EmailSender.psm1 function Send-TagCreatedEmail($tag,$to){ write-host &amp;quot;[EmailSender]**** Sending Email to $to. Message: &amp;#39;CREATED TAG $tag&amp;#39; ****&amp;quot; } InternalDashoard.psm1 function Publish-DeployedApp($appId,$deploymentId){ write-host &amp;quot;[InternalDashboard]***** Publishing Deployment $deploymentId to dashboard ******&amp;quot; } Event Publishers SystemInstaller and SCM modules are also building blocks with no dependencies. Hence, they are also easy to develop, test and reuse. These two modules also publish events when their goal is completed. The events are called AppInstalled and TagCreated respectively. SystemInstaller.psm1 function Install-LocalApp($appId){ $deploymentId = Get-Random -Maximum 100 write-host &amp;quot;[SystemInstaller]***** Intalling app with id $appId. Deployment Id: $deploymentId&amp;quot; New-Event -SourceIdentifier AppInstalled ` -MessageData @{appId = $appId; deploymentId= $deploymentId}|out-null } SCM.psm1 function New-TagForDeployment($deploymentId){ write-host &amp;quot;[SCM]**** Creating Tag for deploymentId $deploymentId******&amp;quot; New-Event -SourceIdentifier TagCreated ` -MessageData @{Tag = &amp;quot;DEPLOYED/$deploymentId&amp;quot;}|out-null } Both modules are raising an event to the Powershell&amp;#8217;s internal event bus. This is done using New-Event Powershell cmdlet, which is only available from version 6.0. Events wouldn&amp;#8217;t be too useful without additional context data. But this means that subscribers to the event need to know how to parse this data, specially when the values are complex types. This is also a type of coupling, which is why is a good idea to keep events with little data and simple structure. Event Subscriber Finally, the top level script will load all building block modules and &quot;connect&quot; their events from some of them to the commands in others. We need to setup three event listeners: When AppInstalled occurs, we publish the news to the InternalDashboard Also, we need to tag the source code using the SCM module Finally, when the SCM module publishes TagCreated, members of the Test teams need to be notified by email, so that they can start testing. Adding subscribers to Powershell events is done with the Register-EngineEvent commandlet. Register-EngineEvent differs from Register-ObjectEvent in that the latter allows listening for events raised by a .net object. The former allows listening for events raised within Powershell. After wiring these events, we proceed with the action: install an application locally. InternallInstaller.psm1 Import-Module SCM Import-Module InternalDashboard Import-Module EmailSender Import-Module SystemInstaller function Install-LocalAppAndNotify($appId){ # When App is Installed, Publish to the Dashboard Register-EngineEvent -SourceIdentifier AppInstalled ` -Action { InternalDashboard\Publish-DeployedApp ` -appId $event.messagedata.appId ` -deploymentId $event.messagedata.deploymentId }|Out-Null # ... and create a tag in source control Register-EngineEvent -SourceIdentifier AppInstalled ` -Action { SCM\New-TagForDeployment ` -deploymentId $event.messagedata.deploymentId }|Out-Null # Email testers when the tag is created Register-EngineEvent -SourceIdentifier TagCreated ` -Action { EmailSender\Send-TagCreatedEmail ` -tag $event.messagedata.Tag ` -to &amp;#39;Testers@myorg.com&amp;#39; }|Out-Null # Now install the application write-host &amp;quot;[InternalInstaller]**** Starting Installation &amp;quot; SystemInstaller\Install-LocalApp -appId $appId #Do not forget to remove event listeners!! Get-EventSubscriber| Remove-Event } When we run this top level script, the end result is as desired. we execute it this way: $env:PSMODULEPATH = $pwd Import-Module InternalInstaller Install-LocalAppAndNotify 42 This is the console output. Notice that the event publish and subscribe pattern is running synchronously [InternalInstaller]**** Starting Installation [SystemInstaller]***** Intalling app with id 42. Deployment Id: 60 [InternalDashboard]***** Publishing Deployment 60 to dashboard ****** [SCM]**** Creating Tag for deploymentId 60****** [EmailSender]**** Sending Email to Testers@myorg.com. Message: &amp;#39;CREATED TAG DEPLOYED/60&amp;#39; ****">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://youarewhatyoucode/2020/04/11/decouple-your-powershell-modules-using-events/">
  
  
  <link rel="alternate" type="application/rss+xml" title="you are what you code" href="http://youarewhatyoucode/feed.xml">
     <!-- favicon -->
    <link rel="shortcut icon" href="http://youarewhatyoucode/favicon.ico" type="image/icon"> 
    <link rel="icon" href="http://youarewhatyoucode/favicon.ico" type="image/icon">

    <!-- favicon -->
    <link rel="shortcut icon" href="http://youarewhatyoucode/favicon.ico?v=2" /> 
    <link rel="icon" href="http://youarewhatyoucode/favicon.ico?v=2" />
        <!-- Start of StatCounter Code -->
<div id="statcounter_image" style="display:inline;"><a
title="web statistics" href="http://statcounter.com/"
class="statcounter"><img
src="//c.statcounter.com/7145507/0/8d806d50/1/" alt="web
statistics" style="border:none;" /></a></div>
    <!-- End of StatCounter Code -->

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Decouple Your Powershell Modules Using Events">
  <meta name="twitter:description" content="(Source Code is available in this GithHub repository) Powershell Modules When building a code base of any language, we want to keep the code organised in encapsulated modules. This enable the code ...">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">you are what you code</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="https://ie.linkedin.com/in/sebastianslutzky">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/sebastianslutzky">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Decouple Your Powershell Modules Using Events</h1>
    
    <p class="post-meta">
      <time datetime="2020-04-11T00:00:00+00:00" itemprop="datePublished">Apr 11, 2020</time>
       
       â€¢ 
  
  
    
  
    
  
    
      <a href="/categories/powershell/">powershell</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
      <a href="/categories/architecture/">architecture</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/publish-subscribe/">publish_subscribe</a>,
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/design-patterns/">design_patterns</a>
    
  

</p>

      
        <meta name="keywords" content="powershell, architecture, publish_subscribe, design_patterns"/>
      
  </header>

  <div class="post-content" itemprop="articleBody">
    <div class="paragraph">
<p><em>(Source Code is available in this <a href="https://github.com/sebastianslutzky/Blog.PowershellEvents">GithHub repository</a>)</em></p>
</div>
<div class="sect1">
<h2 id="powershell_modules">Powershell Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When building a code base of any language, we want to keep the code organised in encapsulated modules.
This enable the code to be testable, maintainable and reusable</p>
</div>
<div class="paragraph">
<p>Powershell offers several ways of organising the code, but the most used is to organise them in <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_modules?view=powershell-7">Modules</a>.
A module in Powershell can include a  <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_modules?view=powershell-7">Manifest  file</a> that declares (among other details) the Modules that this Module depends on.
This dependencies will be pre-loaded when the target Module is loaded.</p>
</div>
<div class="paragraph">
<p>For .Net development, this is similar to dependencies declared in NUget packages.
The Manifest <code>.psd1</code> file is comparable to the <code>.nuspec</code> file in NUget.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why_decoupling">Why decoupling?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even with a tidy organisation of Modules, code reuse and modularity start to show their ugly face:  <a href="https://en.wikipedia.org/wiki/Dependency_hell">dependency hell</a></p>
</div>
<div class="paragraph">
<p>In particular, this article is concerned with two of the problems identified as a side effect of modularity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Many dependencies</p>
</li>
<li>
<p>Long chain of dependencies</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="too_many_unwanted_dependencies_loaded">Too many (unwanted) dependencies loaded</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First attempts at code modularisation do, at some point, fall short in specificity.</p>
</div>
<div class="paragraph">
<p>A module that deals with, for example, deploying an application to an environment, could end up loading modules that are not needed for that specific use case.</p>
</div>
<div class="paragraph float-group">
<div class="title">figure 1 - Diagram of highly coupled modules</div>
<p><span class="image"><img src="/assets/images/psmodules1.png" alt="psmodules1" width="70%"></span></p>
</div>
<div class="paragraph">
<p>For example, figure 1 shows a 4-tier hierarchy of dependencies between modules.</p>
</div>
<div class="paragraph">
<p>The module <code>SystemInstaller</code> installs software in the current machine (cloud or on premises).
One commandlet in this module needs to tag the source code when software is ready to be tested.
When this happens, the <code>SCM</code> module updates an internal Dashboard.</p>
</div>
<div class="paragraph">
<p>Loading <code>SystemInstaller</code> will also load <code>SCM</code>, <code>InternalDashoard</code> and <code>EmailSender</code> modules.
But if we need to just call <code>Install-LocalApp</code> we will only need <code>EmailSender</code>.</p>
</div>
<div class="paragraph">
<p>These modules may be used in different occasions and scenarios.
The combination of these use cases will very likely result in highly coupled modules like in this example, or sometimes much worse.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="long_chain_of_dependencies">Long chain of dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another side effect of loading unwanted modules is that we will also load the dependencies of these unwanted modules.</p>
</div>
<div class="paragraph">
<p>As time passes, more dependencies are loaded to these transitive dependencies and&#8230;&#8203;.one day we find out that loading one module ends up loading 20 modules, of which we only need one or two.</p>
</div>
<div class="paragraph">
<p>This takes up time consumes resources&#8230;&#8203;and it can have unwanted side effects in your environment, such as installing software or writing to the file system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="decoupling_powershell_modules_with_events">Decoupling Powershell modules with Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A better module organisation is to have a "flatter" hierarchical structure.
The top-level modules represent specific use cases, where the lower level are the building blocks.</p>
</div>
<div class="paragraph">
<p>Developers can use the building blocks provided they use <code>get-help</code> and understand the extent of a module.</p>
</div>
<div class="paragraph">
<p>Here is a representation of a flat hierarchy of modules for the previous graph.</p>
</div>
<div class="paragraph float-group">
<p><span class="image"><img src="/assets/images/psmodules2.png" alt="psmodules2"></span></p>
</div>
<div class="paragraph">
<p>In this model, Top Level modules can be thought as <a href="https://en.wikipedia.org/wiki/Mediator_pattern">mediators</a> of the building blocks.
They represent the top level use case that knows what are the different building blocks in place.</p>
</div>
<div class="paragraph">
<p>Dealing with Email Servers, Source Control Management Systems and Dashboards are all independent of each other.
Use cases that need one of these libraries, will import the modules and "wire" them together in a publish-and-subscribe approach.</p>
</div>
<div class="paragraph">
<p>Powershell support for events is neither widely used nor documented, but the language provides the building blocks necessary to implement such pattern.</p>
</div>
<div class="sect2">
<h3 id="implementation_using_events_to_decouple_modules">Implementation: Using events to decouple modules</h3>
<div class="sect3">
<h4 id="building_blocks">Building blocks</h4>
<div class="paragraph">
<p>The <code>EmailSender</code> and <code>InternalDashboard</code> modules have no dependencies.
Their input parameters can be simple primitives like strings or integers.
This make these <em>building block</em> modules very easy to test and develop.</p>
</div>
<div class="listingblock">
<div class="title">EmailSender.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> <span style="color: #008000">Send-TagCreatedEmail</span>(<span style="color: #19177C">$tag</span>,<span style="color: #19177C">$to</span>){
    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[EmailSender]**** Sending Email to $to. Message: &#39;CREATED TAG $tag&#39; ****&quot;</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">InternalDashoard.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> Publish-DeployedApp(<span style="color: #19177C">$appId</span>,<span style="color: #19177C">$deploymentId</span>){
   <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[InternalDashboard]***** Publishing Deployment $deploymentId to dashboard ******&quot;</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event_publishers">Event Publishers</h4>
<div class="paragraph">
<p><code>SystemInstaller</code> and <code>SCM</code> modules are also building blocks with no dependencies.
Hence, they are also easy to develop, test and reuse.</p>
</div>
<div class="paragraph">
<p>These two modules also publish events when their goal is completed.
The events are called <code>AppInstalled</code> and <code>TagCreated</code> respectively.</p>
</div>
<div class="listingblock">
<div class="title">SystemInstaller.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> Install-LocalApp(<span style="color: #19177C">$appId</span>){
    <span style="color: #19177C">$deploymentId</span> = <span style="color: #008000">Get-Random</span> -Maximum 100

    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[SystemInstaller]***** Intalling app with id $appId. Deployment Id: $deploymentId&quot;</span>

    <span style="color: #008000">New-Event</span> -SourceIdentifier AppInstalled `
        -MessageData @{appId = <span style="color: #19177C">$appId</span>; deploymentId= <span style="color: #19177C">$deploymentId</span>}|<span style="color: #008000">out-null</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">SCM.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> <span style="color: #008000">New-TagForDeployment</span>(<span style="color: #19177C">$deploymentId</span>){
    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[SCM]**** Creating Tag for deploymentId $deploymentId******&quot;</span>
    <span style="color: #008000">New-Event</span> -SourceIdentifier TagCreated `
        -MessageData @{Tag = <span style="color: #BA2121">&quot;DEPLOYED/$deploymentId&quot;</span>}|<span style="color: #008000">out-null</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both modules are raising an event to the Powershell&#8217;s internal <code>event bus</code>.
This is done using <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-event?view=powershell-6">New-Event</a> Powershell cmdlet, which is only available from version 6.0.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Events wouldn&#8217;t be too useful without additional context data.
But this means that subscribers to the event need to know how to parse this data, specially when the values are complex types.
This is also a type of coupling, which is why is a good idea to keep events with little data and simple structure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="event_subscriber">Event Subscriber</h4>
<div class="paragraph">
<p>Finally, the top level script will load all building block modules and "connect" their events from some of them to the commands in others.</p>
</div>
<div class="paragraph">
<p>We need to setup three event listeners:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When <code>AppInstalled</code> occurs, we publish the news to the <code>InternalDashboard</code></p>
</li>
<li>
<p>Also, we need to tag the source code using the <code>SCM</code> module</p>
</li>
<li>
<p>Finally, when the <code>SCM</code> module publishes <code>TagCreated</code>, members of the Test teams need to be notified by email, so that they can start testing.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Adding subscribers to Powershell events is done with the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/register-engineevent?view=powershell-6">Register-EngineEvent commandlet</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Register-EngineEvent</code> differs from <code>Register-ObjectEvent</code> in that the latter allows listening for events raised by a .net object.</p>
</div>
<div class="paragraph">
<p>The former allows listening for events raised within Powershell.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After wiring these events, we proceed with the action: install an application locally.</p>
</div>
<div class="listingblock">
<div class="title">InternallInstaller.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000">Import-Module</span> SCM
<span style="color: #008000">Import-Module</span> InternalDashboard
<span style="color: #008000">Import-Module</span> EmailSender
<span style="color: #008000">Import-Module</span> SystemInstaller


<span style="color: #008000; font-weight: bold">function</span> Install-LocalAppAndNotify(<span style="color: #19177C">$appId</span>){
   <span style="color: #408080; font-style: italic"># When App is Installed, Publish to the Dashboard</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier AppInstalled `
   -Action {
       InternalDashboard\Publish-DeployedApp `
        -appId <span style="color: #19177C">$event</span>.messagedata.appId `
        -deploymentId <span style="color: #19177C">$event</span>.messagedata.deploymentId
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># ... and create a tag in source control</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier AppInstalled `
   -Action {
       SCM\<span style="color: #008000">New-TagForDeployment</span> `
        -deploymentId <span style="color: #19177C">$event</span>.messagedata.deploymentId
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># Email testers when the tag is created</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier TagCreated `
   -Action {
       EmailSender\<span style="color: #008000">Send-TagCreatedEmail</span> `
        -tag <span style="color: #19177C">$event</span>.messagedata.Tag `
        -to <span style="color: #BA2121">&#39;Testers@myorg.com&#39;</span>
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># Now install the application</span>
   <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[InternalInstaller]**** Starting Installation &quot;</span>
   SystemInstaller\Install-LocalApp -appId <span style="color: #19177C">$appId</span>

  <span style="color: #408080; font-style: italic">#Do not forget to remove event listeners!!</span>
   <span style="color: #008000">Get-EventSubscriber</span>| <span style="color: #008000">Remove-Event</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run this top level script, the end result is as desired.
we execute it this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #19177C">$env:PSMODULEPATH</span> = <span style="color: #19177C">$pwd</span>
<span style="color: #008000">Import-Module</span> InternalInstaller
Install-LocalAppAndNotify 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the console output.
Notice that the event publish and subscribe pattern is running <strong>synchronously</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>[InternalInstaller]**** Starting Installation
[SystemInstaller]***** Intalling app with id 42. Deployment Id: 60
[InternalDashboard]***** Publishing Deployment 60 to dashboard ******
[SCM]**** Creating Tag for deploymentId 60******
[EmailSender]**** Sending Email to Testers@myorg.com. Message: &#39;CREATED TAG DEPLOYED/60&#39; ****</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
  </div>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'youarewhatyoucode'; // required: replace example with your forum shortname
        // var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/2020/04/11/decouple-your-powershell-modules-using-events/";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; sebastian slutzky - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://youarewhatyoucode/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
