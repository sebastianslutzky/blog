<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>you are what you code</title>
  <meta name="description" content="a pretentiusly simple blog, with a series of coherent tech rambles...">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://www.youarewhatyoucode/">
  
  
  <link rel="alternate" type="application/rss+xml" title="you are what you code" href="https://www.youarewhatyoucode/feed.xml">
     <!-- favicon -->
    <link rel="shortcut icon" href="https://www.youarewhatyoucode/favicon.ico" type="image/icon"> 
    <link rel="icon" href="https://www.youarewhatyoucode/favicon.ico" type="image/icon">

    <!-- favicon -->
    <link rel="shortcut icon" href="https://www.youarewhatyoucode/favicon.ico?v=2" /> 
    <link rel="icon" href="https://www.youarewhatyoucode/favicon.ico?v=2" />
        <!-- Start of StatCounter Code -->
<div id="statcounter_image" style="display:inline;"><a
title="web statistics" href="http://statcounter.com/"
class="statcounter"><img
src="//c.statcounter.com/7145507/0/8d806d50/1/" alt="web
statistics" style="border:none;" /></a></div>
    <!-- End of StatCounter Code -->

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="you are what you code">
  <meta name="twitter:description" content="a pretentiusly simple blog, with a series of coherent tech rambles...">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">you are what you code</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="https://ie.linkedin.com/in/sebastianslutzky">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/sebastianslutzky">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="home">
  

  

  <ul class="post-list">
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2020/04/11/decouple-your-powershell-modules-using-events/">Decouple Your Powershell Modules Using Events</a>
          </h1>

          <p class="post-meta">Apr 11, 2020 â€¢ 
  
  
    
  
    
  
    
      <a href="/categories/powershell/">powershell</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
      <a href="/categories/architecture/">architecture</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/publish-subscribe/">publish_subscribe</a>,
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/design-patterns/">design_patterns</a>
    
  

</p>
        </header>

        <div class="post-content">
          <div class="paragraph">
<p><em>(Source Code is available in this <a href="https://github.com/sebastianslutzky/Blog.PowershellEvents">GithHub repository</a>)</em></p>
</div>
<div class="sect1">
<h2 id="powershell_modules">Powershell Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When building a code base of any language, we want to keep the code organised in encapsulated modules.
This enable the code to be testable, maintainable and reusable</p>
</div>
<div class="paragraph">
<p>Powershell offers several ways of organising the code, but the most used is to organise them in <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_modules?view=powershell-7">Modules</a>.
A module in Powershell can include a  <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_modules?view=powershell-7">Manifest  file</a> that declares (among other details) the Modules that this Module depends on.
This dependencies will be pre-loaded when the target Module is loaded.</p>
</div>
<div class="paragraph">
<p>For .Net development, this is similar to dependencies declared in NUget packages.
The Manifest <code>.psd1</code> file is comparable to the <code>.nuspec</code> file in NUget.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why_decoupling">Why decoupling?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even with a tidy organisation of Modules, code reuse and modularity start to show their ugly face:  <a href="https://en.wikipedia.org/wiki/Dependency_hell">dependency hell</a></p>
</div>
<div class="paragraph">
<p>In particular, this article is concerned with two of the problems identified as a side effect of modularity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Many dependencies</p>
</li>
<li>
<p>Long chain of dependencies</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="too_many_unwanted_dependencies_loaded">Too many (unwanted) dependencies loaded</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First attempts at code modularisation do, at some point, fall short in specificity.</p>
</div>
<div class="paragraph">
<p>A module that deals with, for example, deploying an application to an environment, could end up loading modules that are not needed for that specific use case.</p>
</div>
<div class="paragraph float-group">
<div class="title">figure 1 - Diagram of highly coupled modules</div>
<p><span class="image"><img src="/assets/images/psmodules1.png" alt="psmodules1" width="70%"></span></p>
</div>
<div class="paragraph">
<p>For example, figure 1 shows a 4-tier hierarchy of dependencies between modules.</p>
</div>
<div class="paragraph">
<p>The module <code>SystemInstaller</code> installs software in the current machine (cloud or on premises).
One commandlet in this module needs to tag the source code when software is ready to be tested.
When this happens, the <code>SCM</code> module updates an internal Dashboard.</p>
</div>
<div class="paragraph">
<p>Loading <code>SystemInstaller</code> will also load <code>SCM</code>, <code>InternalDashoard</code> and <code>EmailSender</code> modules.
But if we need to just call <code>Install-LocalApp</code> we will only need <code>EmailSender</code>.</p>
</div>
<div class="paragraph">
<p>These modules may be used in different occasions and scenarios.
The combination of these use cases will very likely result in highly coupled modules like in this example, or sometimes much worse.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="long_chain_of_dependencies">Long chain of dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another side effect of loading unwanted modules is that we will also load the dependencies of these unwanted modules.</p>
</div>
<div class="paragraph">
<p>As time passes, more dependencies are loaded to these transitive dependencies and&#8230;&#8203;.one day we find out that loading one module ends up loading 20 modules, of which we only need one or two.</p>
</div>
<div class="paragraph">
<p>This takes up time consumes resources&#8230;&#8203;and it can have unwanted side effects in your environment, such as installing software or writing to the file system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="decoupling_powershell_modules_with_events">Decoupling Powershell modules with Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A better module organisation is to have a "flatter" hierarchical structure.
The top-level modules represent specific use cases, where the lower level are the building blocks.</p>
</div>
<div class="paragraph">
<p>Developers can use the building blocks provided they use <code>get-help</code> and understand the extent of a module.</p>
</div>
<div class="paragraph">
<p>Here is a representation of a flat hierarchy of modules for the previous graph.</p>
</div>
<div class="paragraph float-group">
<p><span class="image"><img src="/assets/images/psmodules2.png" alt="psmodules2"></span></p>
</div>
<div class="paragraph">
<p>In this model, Top Level modules can be thought as <a href="https://en.wikipedia.org/wiki/Mediator_pattern">mediators</a> of the building blocks.
They represent the top level use case that knows what are the different building blocks in place.</p>
</div>
<div class="paragraph">
<p>Dealing with Email Servers, Source Control Management Systems and Dashboards are all independent of each other.
Use cases that need one of these libraries, will import the modules and "wire" them together in a publish-and-subscribe approach.</p>
</div>
<div class="paragraph">
<p>Powershell support for events is neither widely used nor documented, but the language provides the building blocks necessary to implement such pattern.</p>
</div>
<div class="sect2">
<h3 id="implementation_using_events_to_decouple_modules">Implementation: Using events to decouple modules</h3>
<div class="sect3">
<h4 id="building_blocks">Building blocks</h4>
<div class="paragraph">
<p>The <code>EmailSender</code> and <code>InternalDashboard</code> modules have no dependencies.
Their input parameters can be simple primitives like strings or integers.
This make these <em>building block</em> modules very easy to test and develop.</p>
</div>
<div class="listingblock">
<div class="title">EmailSender.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> <span style="color: #008000">Send-TagCreatedEmail</span>(<span style="color: #19177C">$tag</span>,<span style="color: #19177C">$to</span>){
    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[EmailSender]**** Sending Email to $to. Message: &#39;CREATED TAG $tag&#39; ****&quot;</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">InternalDashoard.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> Publish-DeployedApp(<span style="color: #19177C">$appId</span>,<span style="color: #19177C">$deploymentId</span>){
   <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[InternalDashboard]***** Publishing Deployment $deploymentId to dashboard ******&quot;</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event_publishers">Event Publishers</h4>
<div class="paragraph">
<p><code>SystemInstaller</code> and <code>SCM</code> modules are also building blocks with no dependencies.
Hence, they are also easy to develop, test and reuse.</p>
</div>
<div class="paragraph">
<p>These two modules also publish events when their goal is completed.
The events are called <code>AppInstalled</code> and <code>TagCreated</code> respectively.</p>
</div>
<div class="listingblock">
<div class="title">SystemInstaller.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> Install-LocalApp(<span style="color: #19177C">$appId</span>){
    <span style="color: #19177C">$deploymentId</span> = <span style="color: #008000">Get-Random</span> -Maximum 100

    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[SystemInstaller]***** Intalling app with id $appId. Deployment Id: $deploymentId&quot;</span>

    <span style="color: #008000">New-Event</span> -SourceIdentifier AppInstalled `
        -MessageData @{appId = <span style="color: #19177C">$appId</span>; deploymentId= <span style="color: #19177C">$deploymentId</span>}|<span style="color: #008000">out-null</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">SCM.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000; font-weight: bold">function</span> <span style="color: #008000">New-TagForDeployment</span>(<span style="color: #19177C">$deploymentId</span>){
    <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[SCM]**** Creating Tag for deploymentId $deploymentId******&quot;</span>
    <span style="color: #008000">New-Event</span> -SourceIdentifier TagCreated `
        -MessageData @{Tag = <span style="color: #BA2121">&quot;DEPLOYED/$deploymentId&quot;</span>}|<span style="color: #008000">out-null</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both modules are raising an event to the Powershell&#8217;s internal <code>event bus</code>.
This is done using <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-event?view=powershell-6">New-Event</a> Powershell cmdlet, which is only available from version 6.0.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Events wouldn&#8217;t be too useful without additional context data.
But this means that subscribers to the event need to know how to parse this data, specially when the values are complex types.
This is also a type of coupling, which is why is a good idea to keep events with little data and simple structure.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="event_subscriber">Event Subscriber</h4>
<div class="paragraph">
<p>Finally, the top level script will load all building block modules and "connect" their events from some of them to the commands in others.</p>
</div>
<div class="paragraph">
<p>We need to setup three event listeners:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When <code>AppInstalled</code> occurs, we publish the news to the <code>InternalDashboard</code></p>
</li>
<li>
<p>Also, we need to tag the source code using the <code>SCM</code> module</p>
</li>
<li>
<p>Finally, when the <code>SCM</code> module publishes <code>TagCreated</code>, members of the Test teams need to be notified by email, so that they can start testing.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Adding subscribers to Powershell events is done with the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/register-engineevent?view=powershell-6">Register-EngineEvent commandlet</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Register-EngineEvent</code> differs from <code>Register-ObjectEvent</code> in that the latter allows listening for events raised by a .net object.</p>
</div>
<div class="paragraph">
<p>The former allows listening for events raised within Powershell.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After wiring these events, we proceed with the action: install an application locally.</p>
</div>
<div class="listingblock">
<div class="title">InternallInstaller.psm1</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #008000">Import-Module</span> SCM
<span style="color: #008000">Import-Module</span> InternalDashboard
<span style="color: #008000">Import-Module</span> EmailSender
<span style="color: #008000">Import-Module</span> SystemInstaller


<span style="color: #008000; font-weight: bold">function</span> Install-LocalAppAndNotify(<span style="color: #19177C">$appId</span>){
   <span style="color: #408080; font-style: italic"># When App is Installed, Publish to the Dashboard</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier AppInstalled `
   -Action {
       InternalDashboard\Publish-DeployedApp `
        -appId <span style="color: #19177C">$event</span>.messagedata.appId `
        -deploymentId <span style="color: #19177C">$event</span>.messagedata.deploymentId
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># ... and create a tag in source control</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier AppInstalled `
   -Action {
       SCM\<span style="color: #008000">New-TagForDeployment</span> `
        -deploymentId <span style="color: #19177C">$event</span>.messagedata.deploymentId
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># Email testers when the tag is created</span>
   <span style="color: #008000">Register-EngineEvent</span> -SourceIdentifier TagCreated `
   -Action {
       EmailSender\<span style="color: #008000">Send-TagCreatedEmail</span> `
        -tag <span style="color: #19177C">$event</span>.messagedata.Tag `
        -to <span style="color: #BA2121">&#39;Testers@myorg.com&#39;</span>
   }|<span style="color: #008000">Out-Null</span>

   <span style="color: #408080; font-style: italic"># Now install the application</span>
   <span style="color: #008000">write-host</span> <span style="color: #BA2121">&quot;[InternalInstaller]**** Starting Installation &quot;</span>
   SystemInstaller\Install-LocalApp -appId <span style="color: #19177C">$appId</span>

  <span style="color: #408080; font-style: italic">#Do not forget to remove event listeners!!</span>
   <span style="color: #008000">Get-EventSubscriber</span>| <span style="color: #008000">Remove-Event</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run this top level script, the end result is as desired.
we execute it this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><span></span><span style="color: #19177C">$env:PSMODULEPATH</span> = <span style="color: #19177C">$pwd</span>
<span style="color: #008000">Import-Module</span> InternalInstaller
Install-LocalAppAndNotify 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the console output.
Notice that the event publish and subscribe pattern is running <strong>synchronously</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code><span></span>[InternalInstaller]**** Starting Installation
[SystemInstaller]***** Intalling app with id 42. Deployment Id: 60
[InternalDashboard]***** Publishing Deployment 60 to dashboard ******
[SCM]**** Creating Tag for deploymentId 60******
[EmailSender]**** Sending Email to Testers@myorg.com. Message: &#39;CREATED TAG DEPLOYED/60&#39; ****</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
        </div>
        
          <p class="post-continue">
            <a href="/2020/04/11/decouple-your-powershell-modules-using-events/#disqus_thread">Leave a comment</a>
          </p>

      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/08/04/find-jobs-in-all-jenkins-folders/">Find Jobs In All Jenkins Folders</a>
          </h1>

          <p class="post-meta">Aug 4, 2017 â€¢ 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/jenkins/">jenkins</a>,
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/groovy/">groovy</a>,
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/jenkins-dsl/">jenkins_dsl</a>
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <div class="paragraph">
<p>Sometimes it is useful to list or apply an operation to a Jenkins job based on a regular expression.
The Jenkins DSL plugin, which executes Groovy code within Jenkins, is probably the easier way to achieve this.</p>
</div>
<div class="paragraph">
<p>I was able to find code snippets in my first web search. However, all the solutions I found
had a major limitation: not dealing with Jenkins folder.</p>
</div>
<div class="paragraph">
<p>In case you have not used them yet, <a href="https://wiki.jenkins.io/display/JENKINS/CloudBees+Folders+Plugin">Jenkins folders</a>
is a great plugin that let you organise your jobs into "container" folders, just like you would do on a file system.</p>
</div>
<div class="sect1">
<h2 id="searching_recursively">Searching recursively</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following Groovy snippet will return a list of jobs across <strong>all folders</strong>.
Optionally, you can pass a regular expression to filter out jobs by name.
This regulare expression will be matched against the full name of the job, that is, including
folder names. This allows you, for example, to find all unit tests jobs in a folder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="groovy"><span></span><span style="color: #B00040">def</span> <span style="color: #0000FF">isFolder</span><span style="color: #666666">(</span>abstractJob<span style="color: #666666">){</span>
 <span style="color: #008000; font-weight: bold">return</span> abstractJob<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">().</span><span style="color: #7D9029">getName</span><span style="color: #666666">()</span> <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;com.cloudbees.hudson.plugins.folder.Folder&quot;</span>
<span style="color: #666666">}</span>

<span style="color: #B00040">def</span> <span style="color: #0000FF">collectJobRecursively</span><span style="color: #666666">(</span>abstractJob<span style="color: #666666">,</span>resultCollector<span style="color: #666666">){</span>
  <span style="color: #008000; font-weight: bold">if</span><span style="color: #666666">(</span>isFolder<span style="color: #666666">(</span>abstractJob<span style="color: #666666">))</span>
        <span style="color: #666666">{</span>
            abstractJob<span style="color: #666666">.</span><span style="color: #7D9029">items</span><span style="color: #666666">.</span><span style="color: #7D9029">findAll</span><span style="color: #666666">().</span><span style="color: #7D9029">each</span><span style="color: #666666">{</span> nestedJob <span style="color: #666666">-&gt;</span>
            collectJobRecursively<span style="color: #666666">(</span>nestedJob<span style="color: #666666">,</span>resultCollector<span style="color: #666666">)</span>
        <span style="color: #666666">}</span>
  <span style="color: #666666">}</span>
  <span style="color: #008000; font-weight: bold">else</span>
  <span style="color: #666666">{</span>
    <span style="color: #408080; font-style: italic">//only add actual jobs to the list</span>
    resultCollector <span style="color: #666666">&lt;&lt;</span> abstractJob
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span>

<span style="color: #B00040">def</span> <span style="color: #0000FF">findAll</span><span style="color: #666666">(</span>pattern <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;.*&#39;</span><span style="color: #666666">){</span>
 <span style="color: #B00040">def</span> resultCollector <span style="color: #666666">=</span> <span style="color: #666666">[]</span>
 Jenkins<span style="color: #666666">.</span><span style="color: #7D9029">instance</span><span style="color: #666666">.</span><span style="color: #7D9029">items</span><span style="color: #666666">.</span><span style="color: #7D9029">findAll</span><span style="color: #666666">().</span><span style="color: #7D9029">each</span><span style="color: #666666">{</span> job <span style="color: #666666">-&gt;</span>
    collectJobRecursively<span style="color: #666666">(</span>job<span style="color: #666666">,</span>resultCollector<span style="color: #666666">)</span>
  <span style="color: #666666">}</span>

  <span style="color: #008000; font-weight: bold">return</span> resultCollector
  <span style="color: #666666">.</span><span style="color: #7D9029">findAll</span><span style="color: #666666">{</span>
    <span style="color: #408080; font-style: italic">// apply the regular expression here.</span>
    <span style="color: #408080; font-style: italic">// we are matching the Full Name (including folder names)</span>
      <span style="color: #666666">(</span>it<span style="color: #666666">.</span><span style="color: #7D9029">fullName</span> <span style="color: #666666">=~</span> <span style="color: #BA2121">/$pattern/</span><span style="color: #666666">)</span>
   <span style="color: #666666">}</span>
<span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using_the_recursive_findall_function">Using the recursive findAll function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You  can now use the previous <code>findAll</code> function to search for all unit test jobs in a folder called "master_branch":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="groovy"><span></span>
findAll<span style="color: #666666">(</span><span style="color: #BA2121">&quot;.*/master_branch/.*UnitTest.*&quot;</span><span style="color: #666666">)</span>
<span style="color: #666666">.</span><span style="color: #7D9029">each</span><span style="color: #666666">{</span>
  job <span style="color: #666666">-&gt;</span>
   <span style="color: #008000; font-weight: bold">if</span><span style="color: #666666">(</span>job<span style="color: #666666">.</span><span style="color: #7D9029">lastBuild</span><span style="color: #666666">){</span>
      println job<span style="color: #666666">.</span><span style="color: #7D9029">fullName</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;:&#39;</span> <span style="color: #666666">+</span> job<span style="color: #666666">.</span><span style="color: #7D9029">lastBuild</span><span style="color: #666666">.</span><span style="color: #7D9029">result</span>
    <span style="color: #666666">}</span>
  <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">{</span>
    println job<span style="color: #666666">.</span><span style="color: #7D9029">fullName</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; has not run yet&quot;</span><span style="color: #666666">;</span>
  <span style="color: #666666">}</span>
 <span style="color: #666666">}</span></code></pre>
</div>
</div>
</div>
</div>
        </div>
        
          <p class="post-continue">
            <a href="/2017/08/04/find-jobs-in-all-jenkins-folders/#disqus_thread">Leave a comment</a>
          </p>

      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2017/03/31/delete-stale-git-branches-with-powershell/">Delete Stale Git Branches With Powershell</a>
          </h1>

          <p class="post-meta">Mar 31, 2017 â€¢ 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/git/">git</a>,
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
      <a href="/categories/powershell/">powershell</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <div class="paragraph">
<p>With the increasing adoption of source code management workflows such as <a href="http://nvie.com/posts/a-successful-git-branching-model/">Git Flow</a>,
it is common to keep "stale" branches in local repositories.</p>
</div>
<div class="sect1">
<h2 id="steps_to_reproduce">Steps to reproduce</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The steps needed to end up in this situation are more or less like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dev1 creates &amp; publishes the branch Feature1</p>
<div class="literalblock">
<div class="content">
<pre>git checkout -B Feature1
..make &amp; commit changes..
git push -u origin Feature1</pre>
</div>
</div>
</li>
<li>
<p>Dev2 fetches the branch to collaborate or review</p>
<div class="literalblock">
<div class="content">
<pre>git fetch
git checkout Feature1</pre>
</div>
</div>
</li>
<li>
<p>Dev2 deletes the Feature1 branch after merging it into master</p>
<div class="literalblock">
<div class="content">
<pre># delete the branch on the remote
git push origin --delete Feature1
# delete the branch locally
git branch -D Feature1</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pruning_stale_references">Pruning stale references</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this stage,  Dev1 (and 3, 4 etc) will want to have the deleted branch gone from their workspace too.</p>
</div>
<div class="paragraph">
<p>A quick search will lead you to the <code>prune</code> sub command</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$&gt; git remote update origin --prune
Fetching origin
From https://github.com/sebastianslutzky/TestRepo
x [deleted]         (none)     -&gt; origin/Feature1</pre>
</div>
</div>
<div class="paragraph">
<p>However, this command only removes the reference to the tracking branch, not the local branch itself.
You can see that the orphan branch is still here:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$&gt; git branch -l
 Feature1
 * master</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delete_branches_not_in_the_remote">Delete branches not in the remote</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So here is a simple Powershell script that deletes the orphan local branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="powershell"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><pre><span></span> <span style="color: #19177C">$local</span>=git branch -l
 <span style="color: #19177C">$remote</span>=git branch -r
 <span style="color: #19177C">$local</span>|
    %{<span style="color: #19177C">$_</span>.Trim()}|
    ?{<span style="color: #666666">-not</span> (<span style="color: #19177C">$remote</span> <span style="color: #666666">-like</span> <span style="color: #BA2121">&#39;*&#39;</span> + <span style="color: #19177C">$_</span>) }|
    ?{<span style="color: #666666">-not</span>(<span style="color: #19177C">$_</span> <span style="color: #666666">-match</span> <span style="color: #BA2121">&quot;master&quot;</span> )}|
    %{git branch -D <span style="color: #19177C">$_</span>}
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Surely this code could be compressed in one single piped command, but it could turn a bit confusing.</p>
</div>
<div class="paragraph">
<p>We are getting the list of local and remote branches (lines 1 &amp; 2).
Then we perform a substraction set operation ($local - $remote) (line 5).
This will gives us the set of local branches not in the remote local branches not in the remote.</p>
</div>
<div class="paragraph">
<p>We finally delete them in line 7.</p>
</div>
</div>
</div>
        </div>
        
          <p class="post-continue">
            <a href="/2017/03/31/delete-stale-git-branches-with-powershell/#disqus_thread">Leave a comment</a>
          </p>

      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2015/11/24/take-control-of-your-api-aspects/">Take control of your Web API aspects</a>
          </h1>

          <p class="post-meta">Nov 24, 2015 â€¢ 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/asp-web-api/">asp web api</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
      <a href="/categories/architecture/">architecture</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/net/">.net</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/c/">c#</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <div class="paragraph">
<p>Action filters  are a way of modifying or decorating the execution of one or more action methods. They provide points of execution before and after the action method itself executes.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For more details on action filters see <a href="http://www.asp.net/mvc/overview/older-versions-1/controllers-and-routing/understanding-action-filters-cs"">this article</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="order_of_execution_salami_slice_russian_doll">Order of Execution: Salami Slice + Russian Doll</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can have action filters declared at three levels: globally, controller-wide or action-specific. <strong>They will execute in that order&#8230;&#8203;sort of.</strong></p>
</div>
<div class="paragraph">
<p>Once ordered, action filters are executed <strong>sequentially</strong>, without connection between them.</p>
</div>
<div class="paragraph">
<p>But here&#8217;s the fun bit, the order of execution is reverted when the response is processed. In other words, if when processing the request the order of filters is</p>
</div>
<div class="paragraph">
<p><span class="menuseq"><b class="menu">View</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">FilterA</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">FilterB</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">FilterC</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Action</b></span></p>
</div>
<div class="paragraph">
<p>then when processing the response the order will be</p>
</div>
<div class="paragraph">
<p><span class="menuseq"><b class="menu">View</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Action</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">FilterC</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">FilterB</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Filter</b></span></p>
</div>
<div class="paragraph">
<p>there are some design patterns like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern">Chain of Responsibility</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Command_pattern">Commands</a></p>
</li>
<li>
<p>I prefer to use the more visual <a href="http://blogs.msdn.com/b/skaufman/archive/2005/04/25/411809.aspx">Salami Slice</a>Â for the sequential execution.</p>
</li>
<li>
<p><a href="http://blogs.msdn.com/b/skaufman/archive/2005/04/21/410486.aspx">Russian Doll</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="overriding_a_global_filter_from_an_action_method">Overriding a global filter from an action method</h3>
<div class="paragraph">
<p>This default order is convenient in many cases, but not always. I found myself in the following scenario: I needed to execute a default action filter <strong>unless</strong>Â an action was annotated with an overriding action filter attribute.</p>
</div>
<div class="paragraph">
<p>Two examples when this could be useful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><strong>Always log http traffic, exceptÂ sensitive data: </strong></strong></p>
<div class="ulist">
<ul>
<li>
<p>Log the raw http request and response to all action methods.</p>
</li>
<li>
<p>But: when the request is for PUT /PaymentCardDetails, then use a custom logger that will not log the payment card number and security code.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong><strong>Always require authentication tokens, except Login and Forgot Password methods: </strong></strong></p>
<div class="ulist">
<ul>
<li>
<p>Add a global action filter that will always require authentication token in the request&#8217;s header.</p>
</li>
<li>
<p>But: annotate the Login and ForgotPassword action methods with an attribute that will bypassÂ the authentication requirement.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="so_here_is_the_implementation">&#8230;&#8203;so here is the implementation:</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="step_1_create_an_interface_for_overriding_attributes">Step 1: Create an interface for overriding attributes</h3>
<div class="paragraph">
<p>Something like this is the simplest thing that can possibly do the job:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="c#"><span></span><span style="color: #408080; font-style: italic">//To be implemented by actionfilterattributes that override a global action filter</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> IOverridingFilterAttribute
{
    <span style="color: #408080; font-style: italic">//The type of actionfilter to be replaced for this request</span>
    Type OverriddenType { <span style="color: #008000; font-weight: bold">get</span>; }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step_2_create_your_own_actionfilterprovider_with_the_overriding_behaviour">Step 2: Create your own ActionFilterProvider with the overriding behaviour</h3>
<div class="paragraph">
<p>IFilterProvider is a component you can customise. It defines what action filters to use in this request, and in which order</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="c#"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">OverridingFilterProvider</span> : IFilterProvider
{
    <span style="color: #408080; font-style: italic">//called by WebApi on each request, in order</span>
    <span style="color: #408080; font-style: italic">// to get the list of filters to apply</span>
    <span style="color: #008000; font-weight: bold">public</span> IEnumerable&lt;FilterInfo&gt; GetFilters(HttpConfiguration configuration, HttpActionDescriptor actionDescriptor)
    {
        <span style="color: #B00040">var</span> globalFilters = configuration.Filters;
        <span style="color: #B00040">var</span> controllerFilters = actionDescriptor.ControllerDescriptor.GetFilters().Select(x =&gt; <span style="color: #008000; font-weight: bold">new</span> FilterInfo(x,FilterScope.Controller));
        <span style="color: #B00040">var</span> actionFilters = actionDescriptor.GetFilters().Select(x =&gt; <span style="color: #008000; font-weight: bold">new</span> FilterInfo(x,FilterScope.Action));

        <span style="color: #408080; font-style: italic">//we&#39;ll apply global,controller-wide</span>
        <span style="color: #408080; font-style: italic">//and then action attribute filters</span>
        <span style="color: #B00040">var</span> all = globalFilters.Concat(controllerFilters).Concat(actionFilters);
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #0000FF">RemoveAnyOverriddenFilter</span>(all);
    }

    <span style="color: #408080; font-style: italic">//if there are IOverridingFilterAttributes,</span>
    <span style="color: #408080; font-style: italic">//remove the filters they override</span>
    <span style="color: #008000; font-weight: bold">private</span> IEnumerable&lt;FilterInfo&gt; RemoveAnyOverriddenFilter(IEnumerable&lt;FilterInfo&gt; all)
    {
        <span style="color: #B00040">var</span> overridingFilters =
            all.Where(x =&gt; (x.Instance <span style="color: #008000; font-weight: bold">as</span> IOverridingFilterAttribute) != <span style="color: #008000; font-weight: bold">null</span>)
                .Select(x =&gt; (IOverridingFilterAttribute) x.Instance);

        <span style="color: #B00040">var</span> filtered =  all.Where(x =&gt; !IsOverridden(x, overridingFilters));
        <span style="color: #008000; font-weight: bold">return</span> filtered;
    }

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #B00040">bool</span> <span style="color: #0000FF">IsOverridden</span>(FilterInfo target, IEnumerable&lt;IOverridingFilterAttribute&gt; overrides)
    {
        <span style="color: #008000; font-weight: bold">foreach</span> (<span style="color: #B00040">var</span> overridingFilter <span style="color: #008000; font-weight: bold">in</span> overrides)
        {
            <span style="color: #B00040">var</span> filterType = target.Instance.GetType();
            <span style="color: #B00040">var</span> overriddenType = overridingFilter.OverriddenType;

            <span style="color: #008000; font-weight: bold">if</span> (overriddenType.IsAssignableFrom(filterType))
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">true</span>;
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">false</span>;
    }

    <span style="color: #008000; font-weight: bold">private</span> IEnumerable&lt;FilterInfo&gt; OrderFilters(IEnumerable&lt;IFilter&gt; filters, FilterScope scope)
    {
        <span style="color: #008000; font-weight: bold">return</span> filters.Select(instance =&gt; <span style="color: #008000; font-weight: bold">new</span> FilterInfo(instance, scope));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step_3_register_your_filter_provider">Step 3: Register your Filter Provider</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="c#"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">WebApiApplication</span> : HttpApplication
{
    <span style="color: #008000; font-weight: bold">protected</span> <span style="color: #008000; font-weight: bold">void</span> <span style="color: #0000FF">Application_Start</span>()
    {
        <span style="color: #B00040">var</span> services = GlobalConfiguration.Configuration.Services;
        services.Replace(<span style="color: #008000; font-weight: bold">typeof</span>(IFilterProvider),
            <span style="color: #008000; font-weight: bold">new</span> <span style="color: #0000FF">OverridingFilterProvider</span>());
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
        </div>
        
          <p class="post-continue">
            <a href="/2015/11/24/take-control-of-your-api-aspects/#disqus_thread">Leave a comment</a>
          </p>

      </li>
    
      
      

      <li>
        <header class="post-header">
          <h1 class="post-title">
            <a class="post-link" href="/2011/10/29/naked-objects-is-opensource/">Naked Objects Is Opensource</a>
          </h1>

          <p class="post-meta">Oct 29, 2011 â€¢ 
  
  
    
  
    
  
    
  
    
      <a href="/categories/news/">news</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/nakedobjects/">nakedobjects</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/ddd/">ddd</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
        </header>

        <div class="post-content">
          <div class="paragraph">
<p>The Naked Objects framework for .Net is now open sourced under Microsoft Public License.</p>
</div>
<div class="paragraph">
<p>The projects is now hosted at <a href="http://nakedobjects.codeplex.com/">Codeplex</a></p>
</div>
<div class="paragraph">
<p>You can download the framework from there or in Visual Studio, from NuGet</p>
</div>
        </div>
        
          <p class="post-continue">
            <a href="/2011/10/29/naked-objects-is-opensource/#disqus_thread">Leave a comment</a>
          </p>

      </li>
    
  </ul>

  
  <div class="pagination">
    
      <a class="previous" href="/posts/2/">&laquo; Older</a>
    

    
  </div>



</div>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; sebastian slutzky - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://www.youarewhatyoucode/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
